# calc-invaders（計算インベーダー）

小学生向け「四則×トランプ×ステージ攻略」学習STG。式を解いて敵を撃破し、52枚のカード（4スーツ×1〜13ランク）を集めます。

## 最新UIフロー（エントリ/導線）

1) タイトル画面（`src/ui/title.js`）
- スーツ（範囲）トグル：♡=＋ / ♠=− / ♣=× / ♦=÷
- ランク（1〜13）トグル：各ランクの出題パターンをツールチップ表示
- 問題数モード：5/10/20/30/∞（エンドレス）
- 難易度（スピード）：Easy/Normal/Hard（降下/スポーン速度のみ変更）
- ボタン
  - スタート：選択済みスーツ×ランク×問題数モードで開始
  - ステージ選択（52枚）：カードタワーを開く（下記）

2) ステージ選択（カードタワー、`src/ui/cardTower.js`）
- 4×13のカードグリッドをオーバーレイ表示
- 各カードに「獲得/未獲得/ロック」表示とランクの出題パターン（ツールチップ）
- クリックで当該ステージ開始、閉じるでタイトルに戻る

3) ステージ（`src/main.js`+`src/core/spawnController.js`）
- 下部パネルで入力、弾はパネル中央→選択中の敵へ飛翔、命中で爆発SE/エフェクト
- 敵は列ランダムにスポーンし、インベーダー風に降下
- 非エンドレス：全滅でクリア、エンドレス：無限出題

4) 結果画面（`src/ui/result.js`）
- クリア：カード獲得プレビュー（新規/既存）、再挑戦/次ランク/コレクション/タイトルへ
- ゲームオーバー：再挑戦/ステージ選択/タイトルへ

5) コレクション（`src/ui/collection.js`）
- 52枚の進捗と詳細（初取得日時/最終クリア/クリア回数/ベストスコア）
- 「このステージで遊ぶ」で直接起動可能

6) 設定（`src/ui/settings.js`）
- 効果音(SFX)/音楽(BGM)/音量(全体)
- 時間制限（ON/OFF、秒）
- アクセシビリティ（ボタン大きめ/ハイコントラスト）

## 保存とバージョン

- 保存キー：`ci:v1`（ペイロード内で`schemaVersion`を管理）
- `schemaVersion=2`：`cardMeta`/`gameSettings`/`a11ySettings`/`questionCountMode`などを追加
- 旧データは読み込み時に自動マイグレーション（`migrateState`）

## オーディオ

- 初回解錠：ユーザー操作後に`unlockAudio()`
- BGM：タイトル`bgm_title`、ステージ`bgm_stage`
- SFX：`shot`/`hit`/`miss`/`clear`/`gameover` など
- 実音源は `assets/audio/*.mp3` に配置

## 開発

```bash
npm install
npm run dev
```

Vite開発サーバで起動します。`index.html`のエントリは`src/main.js`です。

## ビルド/デプロイ

```bash
npm run build
```

`dist/` を静的配信してください（SPA想定）。